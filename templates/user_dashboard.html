{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}
{% block extra_css %}
<style>
.user-info-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}
.user-info-card h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
}
.user-info-card .info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}
.user-info-card .info-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 10px;
    border-radius: 8px;
}

/* Player Card - Enhanced with Banner Background */
.player-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.player-card .banner-bg {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 0;
    opacity: 0.3;
}

.player-card .banner-bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.player-card .content {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.player-avatar {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    overflow: hidden;
    border: 3px solid rgba(255, 255, 255, 0.3);
    flex-shrink: 0;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.player-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 5px;
}

.player-info {
    flex: 1;
    min-width: 200px;
}

.player-name {
    font-size: 24px;
    font-weight: 700;
    color: #333;
    margin-bottom: 5px;
    text-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
    word-break: break-word;
}

.player-uid {
    font-size: 14px;
    color: #666;
    font-family: 'Courier New', monospace;
}

.player-level {
    font-size: 32px;
    font-weight: 700;
    color: #667eea;
    margin-left: auto;
    white-space: nowrap;
}

/* Progress Section */
.progress-section {
    margin: 20px 0;
    position: relative;
    z-index: 1;
}

.progress-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    color: #333;
    font-weight: 600;
    font-size: 13px;
    flex-wrap: wrap;
    gap: 10px;
}

.progress-bar-container {
    background: #e0e0e0;
    border-radius: 10px;
    height: 30px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
    margin-bottom: 10px;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    color: #fff;
    font-weight: bold;
    font-size: 11px;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.progress-bar-text {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    font-weight: bold;
    font-size: 11px;
    z-index: 2;
    pointer-events: none;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
}

.exp-info {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    color: #666;
    font-size: 12px;
    flex-wrap: wrap;
    gap: 15px;
}

.exp-info span {
    display: flex;
    align-items: center;
    gap: 5px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
    position: relative;
    z-index: 1;
}

.stat-item {
    background: rgba(102, 126, 234, 0.1);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    border: 1px solid rgba(102, 126, 234, 0.2);
    transition: transform 0.3s, box-shadow 0.3s;
}

.stat-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.stat-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

    .stat-value {
        font-size: 20px;
        font-weight: 700;
        color: #333;
    }
    
    /* Tab Styles */
    .tab-nav {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
        background: #f5f5f5;
        border-radius: 20px 20px 0 0;
    }
    
    .tab-btn {
        flex: 1;
        padding: 15px 20px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: #666;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }
    
    .tab-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
    }
    
    .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }

.accounts-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.accounts-table th,
.accounts-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.accounts-table th {
    background: #f5f5f5;
    font-weight: 600;
    color: #333;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.btn-small {
    padding: 6px 12px;
    font-size: 12px;
}

.input-group {
    display: flex;
    gap: 5px;
    align-items: center;
    flex-wrap: wrap;
}

.input-group input {
    flex: 1;
    min-width: 120px;
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 12px;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #667eea;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .user-info-card {
        padding: 15px;
    }
    
    .user-info-card .info {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .player-card {
        padding: 15px;
    }
    
    .player-card .content {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .player-avatar {
        width: 70px;
        height: 70px;
        font-size: 35px;
    }
    
    .player-info {
        width: 100%;
    }
    
    .player-name {
        font-size: 20px;
    }
    
    .player-level {
        margin-left: 0;
        font-size: 28px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .stat-item {
        padding: 12px;
    }
    
    .stat-label {
        font-size: 11px;
    }
    
    .stat-value {
        font-size: 18px;
    }
    
    .progress-section {
        margin: 15px 0;
    }
    
    .progress-label {
        font-size: 12px;
    }
    
    .progress-bar-container {
        height: 28px;
    }
    
    .progress-bar-text {
        font-size: 10px;
    }
    
    .exp-info {
        font-size: 11px;
        flex-direction: column;
        gap: 8px;
    }
    
    .accounts-table {
        font-size: 12px;
    }
    
    .accounts-table th,
    .accounts-table td {
        padding: 8px;
    }
    
    .input-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .input-group input {
        width: 100%;
        min-width: auto;
    }
}

@media (max-width: 480px) {
    .player-card {
        padding: 12px;
    }
    
    .player-avatar {
        width: 60px;
        height: 60px;
        font-size: 30px;
    }
    
    .player-name {
        font-size: 18px;
    }
    
    .player-level {
        font-size: 24px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .accounts-table {
        font-size: 11px;
    }
    
    .accounts-table th,
    .accounts-table td {
        padding: 6px;
    }
}
</style>
{% endblock %}
{% block content %}
<div class="user-info-card">
    <h3>üë§ User Dashboard</h3>
    <div class="info">
        <div class="info-item"><label>Username</label><br><value>{{ username }}</value></div>
        <div class="info-item"><label>Assigned Account</label><br><value>{{ assigned_account or 'None' }}</value></div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="card" style="padding: 0;">
    <div class="tab-nav" style="display: flex; border-bottom: 2px solid #e0e0e0; background: #f5f5f5; border-radius: 20px 20px 0 0;">
        <button class="tab-btn active" onclick="switchTab('player-info')" id="tab-btn-player">
            üìä Player Info
        </button>
        <button class="tab-btn" onclick="switchTab('account-control')" id="tab-btn-account">
            üéÆ Account Control
        </button>
    </div>
    
    <!-- Player Info Tab -->
    <div id="tab-player-info" class="tab-content active">
        <div style="padding: 25px;">
            <div id="player-info-section" style="display:none">
                <div class="player-card">
                    <div class="banner-bg" id="banner-bg"></div>
                    <div class="content">
                        <div class="player-avatar" id="player-avatar">
                            <span>‚öîÔ∏è</span>
                        </div>
                        <div class="player-info">
                            <div class="player-name" id="player-name">Loading...</div>
                            <div class="player-uid">UID: <span id="player-uid">-</span></div>
                        </div>
                        <div class="player-level">Lv.<span id="player-level">-</span></div>
                    </div>
                    <div class="progress-section" id="progress-section" style="display:none">
                        <div class="progress-label">
                            <span id="progress-percent">0%</span>
                            <span>Level <span id="current-level-display">-</span></span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar" style="width: 0%;"></div>
                            <div class="progress-bar-text" id="progress-text">0 / 0 EXP</div>
                        </div>
                        <div class="exp-info">
                            <span>‚ö° XP Rate: <strong id="xp-rate" style="color: #667eea;">0</strong> XP/min</span>
                            <span>üïê ETA: <strong id="eta">-</strong></span>
                            <span>üéØ Next Level: <strong id="next-level">-</strong></span>
                            <span id="remaining-xp-info" style="display:none;">üìä Remaining XP: <strong id="remaining-xp-value" style="color: #667eea;">0</strong></span>
                            <span id="played-info" style="display:none;">üéÆ Played: <strong id="played-count-value" style="color: #667eea;">0</strong><span id="estimated-played-span"></span></span>
                        </div>
                    </div>
                    <div class="stats-grid" id="stats-grid"></div>
                </div>
            </div>
            <div id="player-info-placeholder" style="text-align: center; padding: 40px; color: #999; display: none;">
                Enter UID and click update to load player info
            </div>
        </div>
    </div>
    
    <!-- Account Control Tab -->
    <div id="tab-account-control" class="tab-content" style="display: none;">
        <div style="padding: 25px;">
            <h2 style="margin-bottom: 20px; color: #333;">üéÆ My Account Control</h2>
            <div id="u1" class="loading">Loading...</div>
            <div id="u2" style="display:none;text-align:center;padding:40px;color:#999">‚ö†Ô∏è No account assigned</div>
            <div id="account-control-placeholder" style="display:none;text-align:center;padding:40px;color:#999">
                Enter UID and click update to load player info
            </div>
            <table class="accounts-table" id="u3" style="display:none">
                <thead>
                    <tr>
                        <th>Account ID</th>
                        <th>Name</th>
                        <th>Team Code</th>
                        <th>UID</th>
                        <th>Status</th>
                        <th>Loop</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="u4"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function() {
    'use strict';
    
    var accountsData = {};
    var currentUID = '';
    var xpTracking = {
        previousExp: 0,
        previousTime: null,
        xpRate: 0,
        history: []
    };
    
    function showPlayerMessage(message, color, hideProgress) {
        var section = document.getElementById('player-info-section');
        if (section) {
            section.style.display = 'block';
        }
        var nameEl = document.getElementById('player-name');
        if (nameEl) {
            nameEl.textContent = message;
            nameEl.style.color = color || '#333';
        }
        var uidEl = document.getElementById('player-uid');
        if (uidEl) {
            uidEl.textContent = '-';
        }
        var levelEl = document.getElementById('player-level');
        if (levelEl) {
            levelEl.textContent = '-';
        }
        // Only hide progress if explicitly requested (not during silent refresh)
        if (hideProgress !== false) {
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('stats-grid').innerHTML = '';
        }
    }
    
    // Don't show message initially - will show in Account Control tab if needed
    
    // Tab switching function
    window.switchTab = function(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(function(tab) {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(function(btn) {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        var selectedTab = document.getElementById('tab-' + tabName);
        var selectedBtn = document.getElementById('tab-btn-' + (tabName === 'player-info' ? 'player' : 'account'));
        
        if (selectedTab) {
            selectedTab.classList.add('active');
            selectedTab.style.display = 'block';
        }
        
        if (selectedBtn) {
            selectedBtn.classList.add('active');
        }
    };
    
    // Level-XP mapping table (from lvlup website)
    var LEVEL_XP_TABLE = {
        1: [0, 48],
        2: [48, 154],
        3: [202, 342],
        4: [544, 468],
        5: [1012, 832],
        6: [1844, 948],
        7: [2792, 1008],
        8: [3800, 1070],
        9: [4870, 1134],
        10: [6004, 1188],
        11: [7192, 1256],
        12: [8448, 1312],
        13: [9760, 1380],
        14: [11140, 1426],
        15: [12566, 1494],
        16: [14060, 1550],
        17: [15610, 1614],
        18: [17224, 1678],
        19: [18902, 1730],
        20: [20632, 1792],
        21: [22424, 1854],
        22: [24278, 1914],
        23: [26192, 1974],
        24: [28166, 2034],
        25: [30200, 2094],
        26: [32294, 2154],
        27: [34448, 3356],
        28: [37804, 3470],
        29: [41274, 3596],
        30: [44870, 3712],
        31: [48582, 4812],
        32: [53394, 5172],
        33: [58566, 5530],
        34: [64096, 5888],
        35: [69994, 6466],
        36: [76460, 7046],
        37: [83506, 7622],
        38: [91128, 8194],
        39: [99322, 8770],
        40: [108092, 12052],
        41: [120144, 13122],
        42: [133266, 14206],
        43: [147472, 15288],
        44: [162760, 16366],
        45: [179126, 17446],
        46: [195672, 18796],
        47: [215368, 20148],
        48: [235516, 21494],
        49: [257010, 22850],
        50: [279860, 24196],
        51: [304056, 44262],
        52: [348318, 46664],
        53: [394982, 49062],
        54: [444044, 51464],
        55: [495508, 53856],
        56: [549364, 84392],
        57: [633756, 87988],
        58: [721744, 91592],
        59: [813336, 95186],
        60: [908522, 132916],
        61: [1044138, 138914],
        62: [1180352, 144914],
        63: [1325266, 150918],
        64: [1476184, 158616],
        65: [1633400, 206646],
        66: [1840946, 215648],
        67: [2056594, 226448],
        68: [2281242, 233638],
        69: [2514880, 242650],
        70: [2757530, 301976],
        71: [3055906, 312778],
        72: [3372284, 327172],
        73: [3699456, 341574],
        74: [4041030, 359972],
        75: [4397002, 432102],
        76: [4829104, 453100],
        77: [5282204, 474100],
        78: [5756304, 495100],
        79: [6251404, 516098],
        80: [6767502, 613822],
        81: [7381324, 661830],
        82: [8043154, 709828],
        83: [8752982, 757826],
        84: [9518088, 805830],
        85: [10316638, 960552],
        86: [11277190, 1014558],
        87: [12297448, 1068556],
        88: [13360304, 1122554],
        89: [14482858, 1176560],
        90: [15659418, 1367220],
        91: [17026708, 1427242],
        92: [18453950, 1487330],
        93: [19941280, 1547290],
        94: [21488570, 1607288],
        95: [23095858, 1667280],
        96: [24763138, 1727290],
        97: [26490428, 1787280],
        98: [28277708, 1847282],
        99: [30124996, 1907288],
        100: [32032284, 0]
    };
    
    // Get level from total EXP (same logic as lvlup website)
    function getLevelFromExp(totalExp) {
        if (totalExp < 0) {
            return { level: 1, currentLevelExp: 0, expNeededForNext: 48, expForNextLevel: 48, levelProgress: 0.0 };
        }
        
        // Find the level based on total EXP
        var levels = Object.keys(LEVEL_XP_TABLE).map(Number).sort(function(a, b) { return b - a; });
        
        for (var i = 0; i < levels.length; i++) {
            var level = levels[i];
            var levelData = LEVEL_XP_TABLE[level];
            var levelStartExp = levelData[0];
            var expNeededForNext = levelData[1];
            
            if (totalExp >= levelStartExp) {
                // Calculate current level progress
                var currentLevelExp = totalExp - levelStartExp;
                
                // Calculate progress percentage
                var levelProgress = 0.0;
                if (expNeededForNext > 0) {
                    levelProgress = Math.min((currentLevelExp / expNeededForNext) * 100, 100.0);
                } else {
                    levelProgress = 100.0; // Max level
                }
                
                // Calculate EXP needed for next level
                var expForNextLevel = 0;
                if (expNeededForNext > 0) {
                    expForNextLevel = Math.max(expNeededForNext - currentLevelExp, 0);
                }
                
                return {
                    level: level,
                    currentLevelExp: currentLevelExp,
                    expNeededForNext: expNeededForNext,
                    expForNextLevel: expForNextLevel,
                    levelProgress: levelProgress
                };
            }
        }
        
        // If total_exp is less than level 1 start
        return { level: 1, currentLevelExp: totalExp, expNeededForNext: 48, expForNextLevel: Math.max(48 - totalExp, 0), levelProgress: Math.min((totalExp / 48) * 100, 100.0) };
    }
    
    // Load accounts
    function loadAccounts() {
        fetch('/api/accounts')
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    accountsData = data.accounts || {};
                    renderAccounts();
                } else {
                    showError('u1', 'Error loading accounts: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Error loading accounts:', err);
                showError('u1', 'Failed to load accounts. Please refresh the page.');
            });
    }
    
    // Show error message
    function showError(elementId, message) {
        var element = document.getElementById(elementId);
        if (element) {
            element.style.display = 'block';
            element.innerHTML = '<span style="color: #ff4444;">‚ùå ' + message + '</span>';
        }
    }
    
    // Store user input values to preserve them during refresh
    var userInputValues = {};
    
    // Render accounts table - optimized to prevent full page refresh feeling
    function renderAccounts() {
        var tbody = document.getElementById('u4');
        var table = document.getElementById('u3');
        var loading = document.getElementById('u1');
        var noAccount = document.getElementById('u2');
        
        if (!tbody || !table || !loading) return;
        
        // Save current input values before updating
        var existingRows = {};
        if (tbody.children.length > 0) {
            for (var i = 0; i < tbody.children.length; i++) {
                var row = tbody.children[i];
                var accountId = row.cells[0].textContent;
                var tcInput = document.getElementById('tc-' + accountId);
                var uidInput = document.getElementById('uid-' + accountId);
                
                if (tcInput) {
                    // Only save if user has modified (different from backend value)
                    var backendTc = accountsData[accountId] ? (accountsData[accountId].team_code || '') : '';
                    if (tcInput.value !== backendTc) {
                        userInputValues['tc-' + accountId] = tcInput.value;
                    } else {
                        delete userInputValues['tc-' + accountId];
                    }
                }
                if (uidInput) {
                    // Only save if user has modified (different from backend value)
                    var backendUid = accountsData[accountId] ? (accountsData[accountId].uid || '') : '';
                    if (uidInput.value !== backendUid) {
                        userInputValues['uid-' + accountId] = uidInput.value;
                    } else {
                        delete userInputValues['uid-' + accountId];
                    }
                }
                
                existingRows[accountId] = row;
            }
        }
        
        loading.style.display = 'none';
        
        if (Object.keys(accountsData).length === 0) {
            table.style.display = 'none';
            noAccount.style.display = 'block';
            // Show placeholder in Account Control tab when no accounts
            var placeholder = document.getElementById('account-control-placeholder');
            if (placeholder) {
                placeholder.style.display = 'block';
            }
            if (tbody.innerHTML !== '') {
                tbody.innerHTML = '';
            }
            return;
        }
        
        // Hide placeholder when accounts exist
        var placeholder = document.getElementById('account-control-placeholder');
        if (placeholder) {
            placeholder.style.display = 'none';
        }
        
        noAccount.style.display = 'none';
        table.style.display = 'table';
        
        // Escape HTML helper
        function escapeHtml(text) {
            if (!text) return '';
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // Update existing rows or create new ones
        for (var accountId in accountsData) {
            var account = accountsData[accountId];
            var existingRow = existingRows[accountId];
            
            // Use user's input value if exists, otherwise use backend value
            var teamCodeValue = userInputValues['tc-' + accountId] !== undefined 
                ? userInputValues['tc-' + accountId] 
                : (account.team_code || '');
            var uidValue = userInputValues['uid-' + accountId] !== undefined 
                ? userInputValues['uid-' + accountId] 
                : (account.uid || '');
            
            var statusClass = account.running ? 'status-active' : 'status-inactive';
            var statusText = account.running ? 'Running' : 'Stopped';
            var loopStatusClass = account.loop_running ? 'status-active' : 'status-inactive';
            var loopStatusText = account.loop_running ? 'Running' : 'Stopped';
            
            var actionBtn = account.running
                ? '<button class="btn btn-warning btn-small" onclick="stopAccount(\'' + accountId + '\')">Stop</button>'
                : '<button class="btn btn-success btn-small" onclick="startAccount(\'' + accountId + '\')">Start</button>';
            
            var loopBtn = account.loop_running
                ? '<button class="btn btn-warning btn-small" onclick="stopAccountLoop(\'' + accountId + '\')">Stop Loop</button>'
                : '<button class="btn btn-success btn-small" onclick="startAccountLoop(\'' + accountId + '\')">Start Level UP</button>';
            
            if (existingRow) {
                // Update existing row - only update what changed to prevent flicker
                var cells = existingRow.cells;
                if (cells[1].textContent !== (account.name || accountId)) {
                    cells[1].textContent = account.name || accountId;
                }
                
                // Update status badges
                var statusBadge = cells[4].querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = 'status-badge ' + statusClass;
                    statusBadge.textContent = statusText;
                }
                
                // Update loop status
                var loopStatusBadge = cells[5].querySelector('.status-badge');
                if (loopStatusBadge) {
                    loopStatusBadge.className = 'status-badge ' + loopStatusClass;
                    loopStatusBadge.textContent = loopStatusText;
                }
                
                // Update action buttons
                var actionsDiv = cells[6].querySelector('.actions');
                if (actionsDiv) {
                    actionsDiv.innerHTML = actionBtn +
                        '<button class="btn btn-primary btn-small" onclick="updateAccount(\'' + accountId + '\')">Update</button>' +
                        '<a href="/account/' + accountId + '" class="btn btn-secondary btn-small" style="text-decoration:none;display:inline-block;">View Details</a>';
                }
                
                // Update loop button
                var loopDiv = cells[5];
                if (loopDiv) {
                    var loopBadge = loopDiv.querySelector('.status-badge');
                    var loopBtnContainer = loopDiv.querySelector('div');
                    if (loopBtnContainer) {
                        loopBtnContainer.innerHTML = '<span class="status-badge ' + loopStatusClass + '">' + loopStatusText + '</span>' + loopBtn;
                    }
                }
                
                // Only update input values if they haven't been modified by user
                var tcInput = cells[2].querySelector('input');
                var uidInput = cells[3].querySelector('input');
                
                if (tcInput && userInputValues['tc-' + accountId] === undefined) {
                    if (tcInput.value !== teamCodeValue) {
                        tcInput.value = teamCodeValue;
                    }
                } else if (tcInput && userInputValues['tc-' + accountId] !== undefined) {
                    // Keep user's value
                    tcInput.value = userInputValues['tc-' + accountId];
                }
                
                if (uidInput && userInputValues['uid-' + accountId] === undefined) {
                    if (uidInput.value !== uidValue) {
                        uidInput.value = uidValue;
                    }
                } else if (uidInput && userInputValues['uid-' + accountId] !== undefined) {
                    // Keep user's value
                    uidInput.value = userInputValues['uid-' + accountId];
                }
            } else {
                // Create new row
                var tr = document.createElement('tr');
                tr.innerHTML = '<td>' + escapeHtml(accountId) + '</td>' +
                    '<td>' + escapeHtml(account.name || accountId) + '</td>' +
                    '<td><div class="input-group"><input type="text" id="tc-' + accountId + '" placeholder="Team Code" value="' + escapeHtml(teamCodeValue) + '"></div></td>' +
                    '<td><div class="input-group"><input type="text" id="uid-' + accountId + '" placeholder="UID" value="' + escapeHtml(uidValue) + '"></div></td>' +
                    '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>' +
                    '<td><div style="display:flex;gap:5px;flex-wrap:wrap"><span class="status-badge ' + loopStatusClass + '">' + loopStatusText + '</span>' + loopBtn + '</div></td>' +
                    '<td><div class="actions" style="display:flex;gap:5px;flex-wrap:wrap">' + actionBtn +
                    '<button class="btn btn-primary btn-small" onclick="updateAccount(\'' + accountId + '\')">Update</button></div></td>';
                tbody.appendChild(tr);
            }
        }
        
        // Remove rows that no longer exist
        for (var i = tbody.children.length - 1; i >= 0; i--) {
            var row = tbody.children[i];
            var accountId = row.cells[0].textContent;
            if (!accountsData[accountId]) {
                tbody.removeChild(row);
            }
        }
        
        // Load player info if UID exists (after all rows are rendered)
        for (var accountId in accountsData) {
            var account = accountsData[accountId];
            if (account.uid && account.uid.trim()) {
                var uidValue = account.uid.trim();
                // Check if this is a new UID or same UID
                if (!currentUID || currentUID !== uidValue) {
                    // New UID - check if we should show loading
                    currentUID = uidValue;
                    setTimeout(function(uidVal, accId) {
                        return function() {
                            // Only mark as initial load if player info section is not visible or empty
                            var playerSection = document.getElementById('player-info-section');
                            var progressSection = document.getElementById('progress-section');
                            if (!playerSection || playerSection.style.display === 'none' || 
                                !progressSection || progressSection.style.display === 'none') {
                                isInitialLoad = true;
                                loadPlayerInfo(uidVal, accId, false); // Show loading
                            } else {
                                isInitialLoad = false; // Already loaded, silent refresh
                                loadPlayerInfo(uidVal, accId, true); // Silent refresh
                            }
                        };
                    }(uidValue, accountId), 500);
                } else {
                    // Same UID - always silent refresh, never show loading
                    setTimeout(function(uidVal, accId) {
                        return function() {
                            isInitialLoad = false; // Never show loading for same UID
                            loadPlayerInfo(uidVal, accId, true); // Always silent refresh
                        };
                    }(uidValue, accountId), 500);
                }
                break; // Only load first account's player info
            }
        }
        
        // Also check UID input value after render
        for (var accountId in accountsData) {
            setTimeout(function(accId) {
                return function() {
                    var uidInput = document.getElementById('uid-' + accId);
                    if (uidInput && uidInput.value && uidInput.value.trim()) {
                        var uidValue = uidInput.value.trim();
                        if (!currentUID || currentUID !== uidValue) {
                            currentUID = uidValue;
                            // Only mark as initial load if not already loaded
                            var playerSection = document.getElementById('player-info-section');
                            var progressSection = document.getElementById('progress-section');
                            if (!playerSection || playerSection.style.display === 'none' || 
                                !progressSection || progressSection.style.display === 'none') {
                                isInitialLoad = true;
                            } else {
                                isInitialLoad = false;
                            }
                            loadPlayerInfo(uidValue, accId, !isInitialLoad);
                        }
                    }
                };
            }(accountId), 1200);
        }
        
        // Fallback: if no UID detected yet, scan all inputs
        setTimeout(function() {
            if (!currentUID) {
                for (var accountId in accountsData) {
                    var uidInput = document.getElementById('uid-' + accountId);
                    if (uidInput && uidInput.value && uidInput.value.trim()) {
                        var uidValue = uidInput.value.trim();
                        if (uidValue.length > 5) {
                            currentUID = uidValue;
                            // Only mark as initial load if not already loaded
                            var playerSection = document.getElementById('player-info-section');
                            var progressSection = document.getElementById('progress-section');
                            if (!playerSection || playerSection.style.display === 'none' || 
                                !progressSection || progressSection.style.display === 'none') {
                                isInitialLoad = true;
                            } else {
                                isInitialLoad = false;
                            }
                            loadPlayerInfo(uidValue, accountId, !isInitialLoad);
                            break;
                        }
                    }
                }
            }
        }, 2000);
    }
    
    // Calculate XP rate
    function calculateXPRate(currentExp) {
        var now = Date.now();
        
        if (xpTracking.previousTime && xpTracking.previousExp > 0) {
            var timeDiff = (now - xpTracking.previousTime) / 1000 / 60; // minutes
            var expDiff = currentExp - xpTracking.previousExp;
            
            if (timeDiff > 0 && expDiff > 0) {
                var rate = expDiff / timeDiff;
                xpTracking.history.push({
                    rate: rate,
                    time: now
                });
                
                // Keep only last 10 measurements
                if (xpTracking.history.length > 10) {
                    xpTracking.history.shift();
                }
                
                // Calculate average rate
                var avgRate = 0;
                if (xpTracking.history.length > 0) {
                    var sum = 0;
                    for (var i = 0; i < xpTracking.history.length; i++) {
                        sum += xpTracking.history[i].rate;
                    }
                    avgRate = sum / xpTracking.history.length;
                }
                
                xpTracking.xpRate = Math.round(avgRate);
            }
        }
        
        xpTracking.previousExp = currentExp;
        xpTracking.previousTime = now;
        
        return xpTracking.xpRate;
    }
    
    // Format time
    function formatTime(minutes) {
        if (!minutes || minutes <= 0) return 'N/A';
        if (minutes < 60) return Math.round(minutes) + ' min';
        var hours = Math.floor(minutes / 60);
        var mins = Math.round(minutes % 60);
        if (hours < 24) return hours + 'h ' + mins + 'm';
        var days = Math.floor(hours / 24);
        hours = hours % 24;
        return days + 'd ' + hours + 'h';
    }
    
    var currentAccountId = null;
    var accountRefreshInterval = null;
    
    var isInitialLoad = true;
    
    // Load player info using account update endpoint (with XP tracking)
    function loadPlayerInfo(uid, accountId, silentRefresh) {
        if (!uid || !uid.trim()) {
            if (!silentRefresh) {
                showPlayerMessage('Enter UID and click update to load player info', '#ff8800');
            }
            return;
        }
        
        if (!accountId) {
            // Try to find account ID from accounts data
            for (var accId in accountsData) {
                if (accountsData[accId].uid === uid.trim()) {
                    accountId = accId;
                    break;
                }
            }
        }
        
        if (!accountId) {
            // Fallback to old method if no account ID found
            if (!silentRefresh) {
                loadPlayerInfoOld(uid);
            }
            return;
        }
        
        uid = uid.trim();
        currentUID = uid;
        currentAccountId = accountId;
        
        // Only show loading message on initial load, not on refresh
        // Check if progress section is already visible - if yes, it's not initial load
        var progressSection = document.getElementById('progress-section');
        var isProgressVisible = progressSection && progressSection.style.display !== 'none';
        
        // Only show loading if it's truly initial load AND not silent refresh AND progress not visible
        if (!silentRefresh && isInitialLoad && !isProgressVisible) {
            showPlayerMessage('Loading player info...', '#667eea', true);
        }
        
        // Use account update endpoint which has XP tracking
        fetch('/api/account/' + accountId + '/update', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
            },
            cache: 'no-cache'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Always update display when data is loaded (silent or not)
                    // This will update all values without showing loading message
                    updatePlayerDisplay(data, uid);
                    isInitialLoad = false;
                    
                    // Start auto-refresh every 20 seconds (silent refresh)
                    if (accountRefreshInterval) {
                        clearInterval(accountRefreshInterval);
                    }
                    accountRefreshInterval = setInterval(function() {
                        // Silent refresh - no loading message, just update data
                        loadPlayerInfo(uid, accountId, true);
                    }, 20000);
                } else {
                    // Only show error on initial load, not on silent refresh
                    if (!silentRefresh) {
                        showPlayerMessage('Unable to load player info: ' + (data.error || 'Unknown error'), '#ff4444', true);
                    }
                    // On silent refresh, just log error but don't change display
                    console.log('Silent refresh error:', data.error);
                }
            })
            .catch(err => {
                console.error('Error loading player info:', err);
                // Only show error on initial load, not on silent refresh
                if (!silentRefresh) {
                    showPlayerMessage('Error loading player info. Please try again.', '#ff4444', true);
                }
                // On silent refresh, just log error but don't change display
                // Don't call showPlayerMessage during silent refresh - it would hide the progress section
            });
    }
    
    // Old method as fallback
    function loadPlayerInfoOld(uid) {
        uid = uid.trim();
        currentUID = uid;
        showPlayerMessage('Loading player info...', '#667eea');
        
        fetch('/api/player-info/' + uid)
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data) {
                    var player = data.data;
                    var totalExp = player.exp || 0;
                    
                    var levelData = getLevelFromExp(totalExp);
                    var level = levelData.level;
                    var currentLevelExp = levelData.currentLevelExp;
                    var expNeededForNext = levelData.expNeededForNext;
                    var expForNextLevel = levelData.expForNextLevel;
                    var levelProgress = levelData.levelProgress;
                    
                    document.getElementById('player-name').textContent = player.nickname || 'N/A';
                    document.getElementById('player-uid').textContent = player.accountId || uid;
                    document.getElementById('player-level').textContent = level;
                    document.getElementById('current-level-display').textContent = level;
                    
                    var progressBar = document.getElementById('progress-bar');
                    var progressText = document.getElementById('progress-text');
                    var progressPercent = document.getElementById('progress-percent');
                    var nextLevel = document.getElementById('next-level');
                    
                    progressBar.style.width = levelProgress + '%';
                    progressText.textContent = currentLevelExp.toLocaleString() + ' / ' + expNeededForNext.toLocaleString() + ' EXP';
                    progressPercent.textContent = levelProgress.toFixed(2) + '% Progress';
                    nextLevel.textContent = 'Level ' + (level + 1);
                    
                    var xpRate = calculateXPRate(totalExp);
                    document.getElementById('xp-rate').textContent = xpRate.toLocaleString();
                    
                    var etaMinutes = xpRate > 0 && expForNextLevel > 0 ? expForNextLevel / xpRate : null;
                    document.getElementById('eta').textContent = formatTime(etaMinutes);
                    
                    document.getElementById('progress-section').style.display = 'block';
                    
                    if (player.bannerId) {
                        var bannerBg = document.getElementById('banner-bg');
                        bannerBg.innerHTML = '<img src="https://cdn.jsdelivr.net/gh/ShahGCreator/icon@main/PNG/' + player.bannerId + '.png" alt="Banner" onerror="this.parentElement.style.display=\'none\'">';
                    }
                    
                    if (player.headPic) {
                        var avatar = document.getElementById('player-avatar');
                        avatar.innerHTML = '<img src="https://cdn.jsdelivr.net/gh/ShahGCreator/icon@main/PNG/' + player.headPic + '.png" alt="Avatar" onerror="this.parentElement.innerHTML=\'‚öîÔ∏è\'">';
                    }
                    
                    var statsGrid = document.getElementById('stats-grid');
                    statsGrid.innerHTML = 
                        '<div class="stat-item"><div class="stat-label">Rank</div><div class="stat-value">' + (player.rank || 0) + '</div></div>' +
                        '<div class="stat-item"><div class="stat-label">Total EXP</div><div class="stat-value">' + totalExp.toLocaleString() + '</div></div>' +
                        '<div class="stat-item"><div class="stat-label">Region</div><div class="stat-value">' + (player.region || 'N/A') + '</div></div>' +
                        '<div class="stat-item"><div class="stat-label">Likes</div><div class="stat-value">' + (player.liked || 0).toLocaleString() + '</div></div>' +
                        '<div class="stat-item"><div class="stat-label">Clan</div><div class="stat-value">' + (player.clanName || 'N/A') + '</div></div>' +
                        '<div class="stat-item"><div class="stat-label">Pet</div><div class="stat-value">' + (player.petName || 'N/A') + '</div></div>';
                    
                    document.getElementById('player-info-section').style.display = 'block';
                } else {
                    showPlayerMessage('Unable to load player info. Please verify UID.', '#ff4444');
                }
            })
            .catch(err => {
                console.error('Error loading player info:', err);
                showPlayerMessage('Error loading player info. Please try again.', '#ff4444');
            });
    }
    
    // Update player display with account tracking data
    function updatePlayerDisplay(data, uid) {
        // Make sure player info section is visible and progress section stays visible
        var playerSection = document.getElementById('player-info-section');
        var progressSection = document.getElementById('progress-section');
        
        if (playerSection) {
            playerSection.style.display = 'block';
        }
        
        // Update basic info
        var nameEl = document.getElementById('player-name');
        var uidEl = document.getElementById('player-uid');
        var levelEl = document.getElementById('player-level');
        var currentLevelDisplay = document.getElementById('current-level-display');
        
        if (nameEl) nameEl.textContent = data.nickname || 'N/A';
        if (uidEl) uidEl.textContent = data.uid || uid;
        if (levelEl) levelEl.textContent = data.level || 'N/A';
        if (currentLevelDisplay) currentLevelDisplay.textContent = data.level || 'N/A';
        
        // Update progress bar - make sure progress section stays visible
        var progressBar = document.getElementById('progress-bar');
        var progressText = document.getElementById('progress-text');
        var progressPercent = document.getElementById('progress-percent');
        var nextLevel = document.getElementById('next-level');
        
        if (progressBar && progressText && progressPercent) {
            var progress = data.progress || 0;
            progressBar.style.width = progress + '%';
            
            var currentExp = data.current_exp || 0;
            var totalExp = data.total_exp || 0;
            progressText.textContent = currentExp.toLocaleString() + ' / ' + totalExp.toLocaleString() + ' EXP';
            progressPercent.textContent = progress.toFixed(2) + '% Progress';
            
            if (nextLevel) {
                if (data.next_level) {
                    nextLevel.textContent = 'Level ' + data.next_level;
                } else if (data.level) {
                    nextLevel.textContent = 'Level ' + (data.level + 1);
                }
            }
            
            // Always show progress section when data is loaded
            if (progressSection) {
                progressSection.style.display = 'block';
            }
        }
        
        // Update XP rate
        var xpRate = data.xp_rate || 0;
        var xpRateEl = document.getElementById('xp-rate');
        if (xpRateEl) {
            xpRateEl.textContent = xpRate.toLocaleString();
            if (xpRate > 0) {
                xpRateEl.style.color = '#00ff41';
            } else {
                xpRateEl.style.color = '#888888';
            }
        }
        
        // Update ETA
        var etaEl = document.getElementById('eta');
        if (etaEl) {
            etaEl.textContent = data.eta || 'Calculating...';
        }
        
        // Update remaining XP
        var remainingXp = data.remaining_xp_to_next || (data.total_exp - data.current_exp) || 0;
        var remainingXpInfo = document.getElementById('remaining-xp-info');
        var remainingXpValue = document.getElementById('remaining-xp-value');
        if (remainingXpInfo && remainingXpValue) {
            remainingXpInfo.style.display = 'inline';
            remainingXpValue.textContent = remainingXp.toLocaleString();
        }
        
        // Update played count
        var playedCount = data.played_count || 0;
        var estimatedPlayed = data.estimated_played || null;
        var playedInfo = document.getElementById('played-info');
        var playedCountValue = document.getElementById('played-count-value');
        var estimatedPlayedSpan = document.getElementById('estimated-played-span');
        if (playedInfo && playedCountValue) {
            if (playedCount > 0) {
                playedInfo.style.display = 'inline';
                playedCountValue.textContent = playedCount.toLocaleString();
                if (estimatedPlayed) {
                    estimatedPlayedSpan.innerHTML = ' / <span style="color: #999;">' + estimatedPlayed.toLocaleString() + ' (Est.)</span>';
                } else {
                    estimatedPlayedSpan.innerHTML = '';
                }
            } else {
                playedInfo.style.display = 'none';
            }
        }
        
        // Update images
        if (data.bannerId) {
            var bannerBg = document.getElementById('banner-bg');
            if (bannerBg) {
                bannerBg.innerHTML = '<img src="https://cdn.jsdelivr.net/gh/ShahGCreator/icon@main/PNG/' + data.bannerId + '.png" alt="Banner" onerror="this.parentElement.style.display=\'none\'">';
            }
        }
        
        if (data.headPic) {
            var avatar = document.getElementById('player-avatar');
            if (avatar) {
                avatar.innerHTML = '<img src="https://cdn.jsdelivr.net/gh/ShahGCreator/icon@main/PNG/' + data.headPic + '.png" alt="Avatar" onerror="this.parentElement.innerHTML=\'‚öîÔ∏è\'">';
            }
        }
        
        // Update stats grid with all tracking data
        var statsGrid = document.getElementById('stats-grid');
        if (statsGrid) {
            var remainingXp = data.remaining_xp_to_next || (data.total_exp - data.current_exp) || 0;
            var playedCount = data.played_count || 0;
            var estimatedPlayed = data.estimated_played || null;
            var currentLevelExp = data.current_level_exp || 0;
            var expForNextLevel = data.exp_for_next_level || 0;
            var levelProgress = data.level_progress || 0;
            var xpRate = data.xp_rate || 0;
            
            var statsHtml = 
                '<div class="stat-item"><div class="stat-label">Rank</div><div class="stat-value">' + (data.rank || 0) + '</div></div>' +
                '<div class="stat-item"><div class="stat-label">Total EXP</div><div class="stat-value">' + (data.exp || 0).toLocaleString() + '</div></div>' +
                '<div class="stat-item"><div class="stat-label">Remaining XP</div><div class="stat-value" style="color: #667eea;">' + remainingXp.toLocaleString() + '</div></div>' +
                '<div class="stat-item"><div class="stat-label">Region</div><div class="stat-value">' + (data.region || 'N/A') + '</div></div>';
            
            if (playedCount > 0) {
                statsHtml += '<div class="stat-item"><div class="stat-label">Played</div><div class="stat-value">' + playedCount.toLocaleString();
                if (estimatedPlayed) {
                    statsHtml += ' / <span style="color: #999; font-size: 0.9em;">' + estimatedPlayed.toLocaleString() + ' (Est.)</span>';
                }
                statsHtml += '</div></div>';
            }
            
            statsHtml += '<div class="stat-item"><div class="stat-label">XP/min</div><div class="stat-value" style="color: ' + (xpRate > 0 ? '#00ff41' : '#888') + ';">' + xpRate.toLocaleString() + '</div></div>';
            
            if (currentLevelExp !== undefined) {
                statsHtml += '<div class="stat-item"><div class="stat-label">EXP in Level</div><div class="stat-value">' + currentLevelExp.toLocaleString() + '</div></div>';
            }
            
            if (expForNextLevel !== undefined) {
                statsHtml += '<div class="stat-item"><div class="stat-label">EXP for Next</div><div class="stat-value">' + expForNextLevel.toLocaleString() + '</div></div>';
            }
            
            if (levelProgress !== undefined) {
                statsHtml += '<div class="stat-item"><div class="stat-label">Level Progress</div><div class="stat-value">' + levelProgress.toFixed(1) + '%</div></div>';
            }
            
            statsGrid.innerHTML = statsHtml;
        }
    }
    
    // Stop account
    window.stopAccount = function(accountId) {
        if (!confirm('Stop account ' + accountId + '?')) return;
        fetch('/api/accounts/' + accountId + '/stop', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.error);
                if (data.success) setTimeout(loadAccounts, 500);
            })
            .catch(err => alert('‚ùå Error: ' + err));
    };
    
    // Start account
    window.startAccount = function(accountId) {
        fetch('/api/accounts/' + accountId + '/start', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.error);
                if (data.success) setTimeout(loadAccounts, 1000);
            })
            .catch(err => alert('‚ùå Error: ' + err));
    };
    
    // Start account loop
    window.startAccountLoop = function(accountId) {
        fetch('/api/accounts/' + accountId + '/loop/start', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.error);
                if (data.success) loadAccounts();
            })
            .catch(err => alert('‚ùå Error: ' + err));
    };
    
    // Stop account loop
    window.stopAccountLoop = function(accountId) {
        if (!confirm('Stop loop for account ' + accountId + '?')) return;
        fetch('/api/accounts/' + accountId + '/loop/stop', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.error);
                if (data.success) loadAccounts();
            })
            .catch(err => alert('‚ùå Error: ' + err));
    };
    
    // Update account (team code and UID)
    window.updateAccount = function(accountId) {
        var teamCode = document.getElementById('tc-' + accountId).value.trim();
        var uid = document.getElementById('uid-' + accountId).value.trim();
        
        if (!teamCode || !uid) {
            alert('‚ùå Please enter both team code and UID');
            return;
        }
        
        fetch('/api/accounts/' + accountId + '/teamcode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team_code: teamCode, uid: uid })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Team code and UID updated successfully!');
                    // Clear user input values since they're now saved to backend
                    delete userInputValues['tc-' + accountId];
                    delete userInputValues['uid-' + accountId];
                    loadAccounts();
                    if (uid) {
                        setTimeout(function() {
                            // Only mark as initial load if not already loaded
                            var playerSection = document.getElementById('player-info-section');
                            var progressSection = document.getElementById('progress-section');
                            if (!playerSection || playerSection.style.display === 'none' || 
                                !progressSection || progressSection.style.display === 'none') {
                                isInitialLoad = true;
                            } else {
                                isInitialLoad = false;
                            }
                            loadPlayerInfo(uid, accountId, !isInitialLoad);
                        }, 500);
                    }
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to update'));
                }
            })
            .catch(err => alert('‚ùå Error: ' + err));
    };
    
    // Initial load
    loadAccounts();
    
    // Auto-refresh accounts every 5 seconds
    setInterval(function() {
        loadAccounts();
    }, 5000);
    
    // Note: Player info auto-refreshes via accountRefreshInterval when loaded
})();
</script>
{% endblock %}
